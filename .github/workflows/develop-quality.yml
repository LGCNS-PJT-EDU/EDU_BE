# .github/workflows/develop-quality.yml
name: Develop Quality

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  quality-gate:
    runs-on: ubuntu-latest

    env:
      # SonarCloud Action이 필요로 하는 토큰
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
    # 1) 코드 체크아웃
    - uses: actions/checkout@v3

    # 2) JDK 21 (Temurin)
    - uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 21

    # 3) Gradle + Sonar 캐시 (공식 액션 하나로 끝)
    - uses: gradle/gradle-build-action@v3
      with:
        cache-read-only: false            # develop 브랜치는 쓰기 허용
        # 테스트·커버리지·빌드까지 묶어서 실행
        arguments: |
          clean test                     \
          jacocoTestReport              \
          jacocoTestCoverageVerification

    # 4) SonarCloud 스캔 (커버리지 XML을 자동 인식)
    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@v2
      with:
        args: >
          -Dsonar.login=${{ env.SONAR_TOKEN }}
